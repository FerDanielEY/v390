<script>
  
{% comment %}

    Renders CIP integration

    Accepts:
    - newsletter_section_id: {string} Newsletter Section ID
    - contact_section_id: {string} Contact Page ID
    - footer_section_id: {string} Footer Section ID
    
{% endcomment %}


{% comment %} Form Check {% endcomment %}

  {% if page_title contains 'Shipping' and page_title contains 'Checkout' %}
    {% assign form_of_sign_up = 'Checkout' %}
      (function($) {
        $(document).on("page:load page:change", function() {
          if (Shopify.Checkout.step === "shipping_method") {
            let form_cip = document.querySelector('body > div.content > div > div > main > div.step > form');
            form_cip.addEventListener('submit', cip_post_request);
            console.log('CIP Checkout');
          }
        });
      })(Checkout.$);
  {% elsif newsletter_section_id %}
    {% assign form_of_sign_up = 'NewsletterSection' %}
    let form_cip = document.querySelector('#contact_form');
    form_cip.addEventListener('submit', cip_post_request);
    console.log('CIP Newsletter Section');
  {% elsif contact_section_id %}
    {% assign form_of_sign_up = 'ContactPage' %}
    let form_cip = document.getElementById('ContactForm');
    form_cip.addEventListener('submit', cip_post_request);
    console.log('CIP Contact Section');
  {% endif %}  

  {% if footer_section_id %}
    {% assign form_of_sign_up = 'FooterSection' %}
    let form_footer_cip = document.getElementById('ContactFooter');
    form_footer_cip.addEventListener('submit', cip_post_request);
    console.log('CIP Footer Section');
  {% endif %}  

  
{% comment %}   Actual POST Request Function and variables declaration {% endcomment %}

function cip_post_request() {

  {% comment %} Payload variables {% endcomment %}
  {% if page_title contains 'Checkout' %}
    const email = '{{ checkout.email }}';
  {% else %}
    const email = document.querySelector('input[type="email"]').value;
  {% endif %}
  const newsletterId = '{{ settings.cip_newsletter_id }}';
  const dataSource = '{{ settings.cip_artist }}_{{ settings.cip_campaign }}_{{ form_of_sign_up }}_Shopify';
  const ref_url = '{{ shop.url }}';

  console.log(email)
  console.log(newsletterId)
  console.log(dataSource)
  console.log(ref_url)
  
  const url = `https://signup.wmg.com/register`;

  {% comment %} POST Request {% endcomment %}
  fetch(url, {
    method: 'POST',
    headers: {
      'Accept': 'text/html'
    },
    body: JSON.stringify({ email, newsletterId, dataSource, ref_url })
  })
  .then(response => response.text())
  .then(data => {
    console.log('Success:', data);
  })
  .catch(error => {
    console.error('Error:', error);
  });

  console.log('Submitted Form ', url)
}

console.log('CIP loaded')

</script>
